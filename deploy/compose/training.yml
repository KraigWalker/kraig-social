services:
  kraig-training:
    build:
      context: ../..
      dockerfile: deploy/docker/training.Dockerfile
      target: kraig-training
    networks:
      - dokploy-network
    environment:
      - TRAINING_API_BASE_URL=http://kraig-training-api:8787
    labels:
      - traefik.enable=true
      - traefik.docker.network=dokploy-network
      - traefik.http.routers.kraig-training.rule=Host(`kraig.social`) && PathPrefix(`/training`)
      - traefik.http.routers.kraig-training.priority=100
      - traefik.http.services.kraig-training.loadbalancer.server.port=3000

  kraig-training-admin:
    build:
      context: ../..
      dockerfile: deploy/docker/training.Dockerfile
      target: kraig-training-admin
    ports:
      - "127.0.0.1:4010:3000"
    networks:
      - dokploy-network
    environment:
      - TRAINING_API_ORIGIN=https://kraig.social
      - TRAINING_API_BASE_URL=http://kraig-training-api:8787

  kraig-training-api:
    build:
      context: ../..
      dockerfile: deploy/docker/training.Dockerfile
      target: kraig-training-api
    networks:
      - dokploy-network
    environment:
      - NODE_ENV=production
      - PORT=8787
      - DATABASE_URL=${DATABASE_URL}
      - APP_NAME=${APP_NAME:-Kraig Training}
      - BETTER_AUTH_URL=${BETTER_AUTH_URL}
      - BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET}
      - traefik.enable=true
      - traefik.docker.network=dokploy-network
      - traefik.http.routers.kraig-training-api.rule=Host(`kraig.social`) && PathPrefix(`/training/api`)
      - traefik.http.routers.kraig-training-api.priority=120
      - traefik.http.routers.kraig-training-api.middlewares=kraig-training-api-strip
      - traefik.http.middlewares.kraig-training-api-strip.stripprefix.prefixes=/training/api
      - traefik.http.middlewares.kraig-training-api-strip.stripprefix.forceSlash=false
      - traefik.http.services.kraig-training-api.loadbalancer.server.port=8787

networks:
  dokploy-network:
    external: true
