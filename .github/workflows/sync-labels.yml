name: Sync labels

on:
  workflow_dispatch:
  push:
    paths:
      - .github/labels.yml

jobs:
  sync:
    name: Sync GitHub labels from labels.yml
    runs-on: ubuntu-latest

    permissions:
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sync labels
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");

            const LABELS_PATH = ".github/labels.yml";
            const raw = fs.readFileSync(LABELS_PATH, "utf8");

            // Parse a small YAML subset:
            // - list items starting with "- "
            // - keys: name, color, description
            // - values may be quoted or unquoted
            function parseLabels(yaml) {
              const items = [];
              let current = null;

              const lines = yaml.split(/\r?\n/);
              for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed || trimmed.startsWith("#")) continue;

                if (line.startsWith("- ")) {
                  if (current) items.push(current);
                  current = {};
                  const rest = line.slice(2).trim();

                  // support inline "- name: docs"
                  const m = rest.match(/^(\w+):\s*(.*)$/);
                  if (m) {
                    current[m[1]] = m[2].trim().replace(/^"(.*)"$/s, "$1");
                  }
                  continue;
                }

                if (!current) continue;

                const m = line.match(/^\s*(\w+):\s*(.*)$/);
                if (!m) continue;

                const key = m[1];
                let value = m[2].trim();

                // strip surrounding quotes
                value = value.replace(/^"(.*)"$/s, "$1");
                current[key] = value;
              }

              if (current) items.push(current);
              return items;
            }

            const desired = parseLabels(raw);

            // Validate items so failures are obvious
            for (const l of desired) {
              if (!l.name) {
                throw new Error(`labels.yml: missing "name" in item: ${JSON.stringify(l)}`);
              }
              if (!l.color) {
                throw new Error(`labels.yml: missing "color" for "${l.name}"`);
              }
              if (!l.description) {
                throw new Error(`labels.yml: missing "description" for "${l.name}"`);
              }
            }

            const { owner, repo } = context.repo;

            const existing = await github.paginate(
              github.rest.issues.listLabelsForRepo,
              { owner, repo, per_page: 100 }
            );

            const byName = new Map(existing.map((l) => [l.name, l]));

            for (const label of desired) {
              const color = String(label.color).replace(/^#/, "");

              if (!byName.has(label.name)) {
                await github.rest.issues.createLabel({
                  owner,
                  repo,
                  name: label.name,
                  color,
                  description: label.description,
                });
                core.info(`Created: ${label.name}`);
              } else {
                const e = byName.get(label.name);
                const existingDesc = e.description ?? "";
                if (e.color !== color || existingDesc !== label.description) {
                  await github.rest.issues.updateLabel({
                    owner,
                    repo,
                    name: label.name,
                    color,
                    description: label.description,
                  });
                  core.info(`Updated: ${label.name}`);
                } else {
                  core.info(`No change: ${label.name}`);
                }
              }
            }

            core.info(`Done. Synced ${desired.length} labels.`);
