name: Sync labels

on:
  workflow_dispatch:
  push:
    paths:
      - .github/labels.yml

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const raw = fs.readFileSync('.github/labels.yml', 'utf8');

            // VERY small YAML parser (enough for this file shape)
            function parseLabels(yaml) {
              return yaml
                .split('\n- ')
                .map(s => s.trim())
                .filter(Boolean)
                .map(block => {
                  const lines = block.split('\n');
                  const obj = {};
                  for (const line of lines) {
                    const m = line.match(/^(\w+):\s*"?(.+?)"?$/);
                    if (m) obj[m[1]] = m[2];
                  }
                  return obj;
                });
            }

            const desired = parseLabels(raw);

            const { owner, repo } = context.repo;

            const existing = await github.paginate(
              github.rest.issues.listLabelsForRepo,
              { owner, repo, per_page: 100 }
            );

            const byName = new Map(existing.map(l => [l.name, l]));

            for (const label of desired) {
              const color = label.color.replace(/^#/, '');

              if (!byName.has(label.name)) {
                await github.rest.issues.createLabel({
                  owner,
                  repo,
                  name: label.name,
                  color,
                  description: label.description
                });
                core.info(`Created: ${label.name}`);
              } else {
                const e = byName.get(label.name);
                if (e.color !== color || (e.description ?? '') !== label.description) {
                  await github.rest.issues.updateLabel({
                    owner,
                    repo,
                    name: label.name,
                    color,
                    description: label.description
                  });
                  core.info(`Updated: ${label.name}`);
                }
              }
            }
